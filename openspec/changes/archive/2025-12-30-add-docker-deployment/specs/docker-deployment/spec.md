# docker-deployment 规范增量

## 新增需求

### 需求：Docker 镜像构建能力
系统必须提供完整的 Docker 容器化支持，允许用户通过 Docker 构建和运行 Markdown 到微信公众号 HTML 转换 API 服务。

#### 场景：构建 Docker 镜像
- **给定**：项目包含有效的 Dockerfile 和所有必要的依赖文件
- **当**：执行 `docker build -t mk2wxhtml4api:latest .` 命令时
- **那么**：
  - 构建过程成功完成，无错误输出
  - 生成的镜像大小不超过 200MB
  - 镜像包含运行所需的所有依赖和资源文件
  - 镜像层数合理（少于 15 层）

#### 场景：使用非 root 用户运行容器
- **给定**：Docker 镜像已构建完成
- **当**：容器启动时
- **那么**：
  - 应用进程以非 root 用户身份运行
  - 用户名为 `nodeuser`（或类似的非特权用户）
  - 遵循最小权限原则

#### 场景：健康检查配置
- **给定**：Docker 容器正在运行
- **当**：Docker 引擎执行健康检查时
- **那么**：
  - 健康检查指向 `/health` 端点
  - 检查间隔为 30 秒
  - 超时时间为 3 秒
  - 连续 3 次失败后容器标记为 unhealthy
  - 健康检查返回 HTTP 200 状态码表示健康

---

### 需求：容器运行能力
系统必须支持通过标准 Docker 命令运行容器，并正确处理网络和端口配置。

#### 场景：使用默认配置运行容器
- **给定**：Docker 镜像已构建
- **当**：执行 `docker run -p 3002:3000 mk2wxhtml4api:latest` 时
- **那么**：
  - 容器成功启动，无错误日志
  - 服务监听在容器内的 3000 端口
  - 主机端口 3002 映射到容器端口 3000
  - 可通过 http://localhost:3002 访问服务

#### 场景：使用自定义端口运行容器
- **给定**：Docker 镜像已构建
- **当**：执行 `docker run -p 8080:3000 -e PORT=3000 mk2wxhtml4api:latest` 时
- **那么**：
  - 容器成功启动
  - 服务仍然监听容器内的 3000 端口
  - 主机端口 8080 映射到容器端口 3000
  - 可通过 http://localhost:8080 访问服务

#### 场景：设置运行环境变量
- **给定**：需要配置生产环境
- **当**：执行 `docker run -e NODE_ENV=production mk2wxhtml4api:latest` 时
- **那么**：
  - 容器内的 NODE_ENV 环境变量设置为 production
  - 应用以生产模式运行

---

### 需求：Docker Compose 部署能力
系统必须提供 docker-compose.yml 配置文件，简化本地开发和部署流程。

#### 场景：使用 Docker Compose 启动服务
- **给定**：项目包含有效的 docker-compose.yml 文件
- **当**：执行 `docker-compose up` 时
- **那么**：
  - 服务成功启动
  - 所有容器进入 healthy 状态
  - 服务可通过主机端口 3002 访问（映射到容器端口 3000）
  - 控制台输出清晰的启动日志

#### 场景：使用 Docker Compose 停止服务
- **给定**：Docker Compose 管理的服务正在运行
- **当**：执行 `docker-compose down` 时
- **那么**：
  - 所有容器停止并移除
  - 网络资源正确清理
  - 无残留进程或资源

#### 场景：Docker Compose 重启策略
- **给定**：容器因错误崩溃
- **当**：容器异常退出时
- **那么**：
  - 重启策略生效
  - 容器自动重启（除非被手动停止）
  - 遵循 `unless-stopped` 策略

---

### 需求：样式模板资源访问
Docker 容器内运行的服务必须能够正确访问 `temp/` 目录中的样式模板文件。

#### 场景：加载样式模板文件
- **给定**：容器正在运行，temp/ 目录已正确打包到镜像中
- **当**：转换服务需要应用样式模板时
- **那么**：
  - 样式模板文件可被正确读取
  - 文件路径为 `/app/temp/样式模板.html`
  - 转换后的 HTML 包含正确的样式

#### 场景：样式模板文件缺失处理
- **给定**：容器正在运行
- **当**：样式模板文件不存在或无法读取时
- **那么**：
  - 返回明确的错误响应
  - 错误码为 `TEMPLATE_NOT_FOUND`
  - 日志中记录详细的错误信息

---

### 需求：镜像构建优化
Dockerfile 必须采用最佳实践，确保镜像体积小、构建快、安全性高。

#### 场景：利用 Docker 构建缓存
- **给定**：代码修改后需要重新构建镜像
- **当**：依赖（package.json）未变化时
- **那么**：
  - 依赖安装层被缓存
  - 仅重新构建应用层
  - 构建时间显著减少

#### 场景：排除不必要的文件
- **给定**：项目根目录包含 .dockerignore 文件
- **当**：执行 Docker 构建时
- **那么**：
  - `node_modules/` 不被复制到镜像
  - `.git/` 不被复制到镜像
  - `test/` 目录不被复制到镜像
  - `.env` 文件不被复制到镜像
  - 编辑器配置目录（.vscode/.cursor/.claude）不被复制
  - 最终镜像体积最小化

---

### 需求：文档完整性
系统必须提供清晰完整的 Docker 部署文档，帮助用户快速上手。

#### 场景：快速开始指南
- **给定**：用户首次使用 Docker 部署
- **当**：阅读 README.md 中的 Docker 部署章节时
- **那么**：
  - 包含前置条件说明（安装 Docker）
  - 提供完整的构建命令
  - 提供完整的运行命令
  - 提供验证服务可用性的命令
  - 步骤清晰易懂

#### 场景：故障排查指南
- **给定**：用户遇到 Docker 部署问题
- **当**：查阅 DOCKER.md 文档时
- **那么**：
  - 包含常见问题及解决方案
  - 说明如何查看容器日志
  - 说明如何进入容器调试
  - 说明端口冲突的处理方法
  - 说明权限问题的处理方法

---

## 相关规范
- **wechat-api**: 本规范新增的功能服务于 wechat-api 规范，为 API 服务提供容器化部署能力

## 变更影响
- **新增文件**：Dockerfile、.dockerignore、docker-compose.yml
- **修改文件**：README.md（添加 Docker 部署说明）
- **不影响**：现有代码和功能完全兼容
